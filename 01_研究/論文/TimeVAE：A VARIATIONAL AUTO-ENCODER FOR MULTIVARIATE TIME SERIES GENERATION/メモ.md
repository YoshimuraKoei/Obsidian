

> [!NOTE] LINE Yahoo 問4
> 長時間の稼働で徐々に増えるメモリ使用量の原因究明と対策の進め方を記述する。
> 一定時間ごとに高い負荷がかかるWebアプリが、稼働から数日後に不安定になる。 
> あなたは、どのようなメトリクスを集めると原因が推測できるか、どのように条件を絞って再現しやすくするかを説明してください。
> 記録の取り方、保たれ続けている参照の見つけ方、使わなくなった情報を回収できるようにする考え方、必要であれば最大量の上限を設定する手段などを、順序立てて説明してください。
> 最後に、完全な解決までの間に停止を避けるための暫定案を短く添える。

![[Pasted image 20251103150142.png]]

![[Pasted image 20251103150229.png]]

1. ユーザー → Webサーバにリクエスト送信
2. Webサーバがアプリケーションロジックを実行  
    → 一時的なオブジェクトを生成（RAM使用）
3. Webサーバ → DBサーバへSQL送信
4. DBサーバがデータをRAM上のバッファから取得（RAM使用）
5. 結果を返してWebサーバがレスポンスを組み立てる
6. 不要になったオブジェクトはGCまたは明示的に解放
7. OSが空いたメモリを再利用

この間ずっと、OSは

> 「このプロセスは200MB使ってる」「空きが10GBある」「キャッシュをどれだけ残そうか」  
> と監視・管理しています。

---
### 構造別にみる「長時間稼働でメモリが増える」主な原因とメトリクス

#### Webサーバ

| カテゴリ             | 内容                           | 典型例                                                                    |
| ---------------- | ---------------------------- | ---------------------------------------------------------------------- |
| メモリリーク           | オブジェクト・配列・セッション・クロージャが解放されない | Python: list/dictにappendしっぱなしNode.js: クロージャ参照保持Java: static変数が大きな参照を保持 |
| キャッシュ肥大化         | キャッシュ上限がなく増え続ける              | Redis/ローカルキャッシュ/Flask cacheなど                                          |
| リクエスト単位の一時データ未解放 | 大きなレスポンス生成時にオブジェクトを保持        | JSONシリアライズ、画像変換、AI推論など                                                 |
| GC設定不備           | ガーベジコレクタのしきい値が不適切            | JVMヒープ領域が肥大、Pythonの循環参照残留                                              |
| 外部接続の未解放         | DB・ファイル・ソケット・スレッドが閉じない       | `connection.close()`しない／`with`未使用                                      |

| 種別      | メトリクス名                     | 観察目的          | 代表ツール                                 |
| ------- | -------------------------- | ------------- | ------------------------------------- |
| プロセスメモリ | RSS / VSS                  | 使用メモリの増加傾向    | `top`, `ps`, `htop`, Prometheus       |
| ヒープ領域   | heap size / old gen / GC回数 | リーク傾向やGC遅延を検出 | GCログ, `jstat`, `tracemalloc`          |
| オブジェクト数 | type別インスタンス数               | どの型が増え続けているか  | `objgraph`, `memory_profiler`         |
| FD数     | open file descriptors      | リソースリークの兆候    | `lsof`, `ulimit`, Prometheus exporter |

#### DBサーバ


#### OS